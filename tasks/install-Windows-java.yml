---
- block:
  - name: Install Chocolatey package
    win_chocolatey:
      name: chocolatey
      state: present

  - name: Set target Java package name
    set_fact:
      java_package_name: "Microsoft-openjdk-{{ java_version | default('21') }}"

  - name: Query for existing Microsoft OpenJDK packages
    ansible.windows.win_shell: |
      choco list --local-only --exact --all-versions Microsoft-openjdk-* -r
    register: choco_java_packages
    changed_when: false
    failed_when: false

  - name: Parse installed Java packages
    set_fact:
      installed_java_packages: "{{ choco_java_packages.stdout_lines | map('split', '|') | list }}"
    when: choco_java_packages.stdout_lines | length > 0

  - name: Display installed Java packages
    debug:
      msg: "Found installed Java packages: {{ installed_java_packages | default([]) }}"

  - name: Check if target version is already installed
    set_fact:
      java_already_installed: "{{ installed_java_packages | default([]) | selectattr('0', 'equalto', java_package_name) | list | length > 0 }}"
      java_needs_upgrade: "{{ (installed_java_packages | default([]) | length > 0) and (installed_java_packages | default([]) | selectattr('0', 'equalto', java_package_name) | list | length == 0) }}"

  - name: Display Java installation status
    debug:
      msg: >-
        {% if java_already_installed %}
        Java {{ java_version | default('21') }} already installed
        {% elif java_needs_upgrade %}
        Java upgrade needed - will uninstall existing package(s) first
        {% else %}
        Java not found - will install
        {% endif %}

  - name: Uninstall old Java packages for upgrade
    win_chocolatey:
      name: "{{ item[0] }}"
      state: absent
    loop: "{{ installed_java_packages | default([]) }}"
    when:
      - java_needs_upgrade
      - item[0] != java_package_name

  - name: Get Java package version for directory name
    ansible.windows.win_shell: |
      choco list --local-only --exact {{ java_package_name }} -r | Select-String -Pattern "{{ java_package_name }}\|" | ForEach-Object { $_.Line.Split('|')[1] }
    register: choco_java_version_query
    changed_when: false
    failed_when: false
    when: not java_already_installed or java_needs_upgrade

  - name: Set Java versioned directory path
    set_fact:
      java_version_for_install: "{{ choco_java_version_query.stdout | trim if (choco_java_version_query.stdout is defined and choco_java_version_query.stdout | length > 0) else (java_version | default('21')) }}"
      java_versioned_dir: "{{ java_install_base_dir }}/jdk-{{ java_version | default('21') }}"
      java_home: "{{ java_install_base_dir }}/{{ java_symlink_name }}"

  - name: Check if symlink exists
    ansible.windows.win_stat:
      path: "{{ java_home }}"
    register: java_symlink_stat

  - name: Remove old symlink for upgrade
    ansible.windows.win_file:
      path: "{{ java_home }}"
      state: absent
    when: java_symlink_stat.stat.exists and java_needs_upgrade

  - name: Install "{{ java_package_name }}"
    win_chocolatey:
      name:
      - "{{ java_package_name }}"
      state: latest
      choco_args: '-f -y'
      install_args: "INSTALLDIR={{ java_versioned_dir }}"
    when: not java_already_installed or java_needs_upgrade
    register: java_install_result

  - name: Create symlink to current Java version
    ansible.windows.win_command: 'cmd /c mklink /D "{{ java_home }}" "{{ java_versioned_dir }}"'
    when: not java_already_installed or java_needs_upgrade or not java_symlink_stat.stat.exists
    register: java_symlink_result
    failed_when: java_symlink_result.rc != 0 and 'already exists' not in java_symlink_result.stderr

  - name: Display symlink creation result
    debug:
      msg: "Java symlink created: {{ java_home }} -> {{ java_versioned_dir }}"
    when: java_symlink_result is changed

  - name: Find all Java version directories for cleanup
    ansible.windows.win_find:
      paths: "{{ java_install_base_dir }}"
      patterns: "jdk-*"
      file_type: directory
    register: all_java_dirs
    when: java_keep_versions | int > 0

  - name: Sort Java directories by modification time (newest first)
    set_fact:
      sorted_java_dirs: "{{ all_java_dirs.files | sort(attribute='lastwritetime') | reverse | list }}"
    when:
      - java_keep_versions | int > 0
      - all_java_dirs.files is defined
      - all_java_dirs.files | length > 0

  - name: Identify old Java versions to remove
    set_fact:
      java_dirs_to_remove: "{{ sorted_java_dirs[java_keep_versions | int:] }}"
    when:
      - java_keep_versions | int > 0
      - sorted_java_dirs is defined
      - sorted_java_dirs | length > (java_keep_versions | int)

  - name: Display Java versions to be removed
    debug:
      msg: "Removing old Java version: {{ item.path }}"
    loop: "{{ java_dirs_to_remove | default([]) }}"
    when: java_dirs_to_remove is defined

  - name: Remove old Java versions beyond retention policy
    ansible.windows.win_file:
      path: "{{ item.path }}"
      state: absent
    loop: "{{ java_dirs_to_remove | default([]) }}"
    when:
      - java_keep_versions | int > 0
      - java_dirs_to_remove is defined
      - java_dirs_to_remove | length > 0

  - name: Set JAVA_HOME environment variable
    win_environment:
      name: JAVA_HOME
      value: "{{ java_home }}"
      level: machine

  - name: Set java_home fact
    set_fact:
      java_home: "{{ java_home }}"


  - name: Add Java to PATH
    win_path:
      elements:
        - "{{ java_home }}/bin"

  - name: Query final installed Java packages
    ansible.windows.win_shell: |
      choco list --local-only --exact --all-versions Microsoft-openjdk-* -r
    register: choco_final_packages
    changed_when: false
    failed_when: false

  - name: Display final installed Java packages
    debug:
      msg: "Installed Java packages after installation: {{ choco_final_packages.stdout_lines }}"

  - name: Verify Java installation
    win_command: "{{ java_home | default('c:/java') }}/bin/java.exe -version"
    register: java_version_output
    changed_when: false

  - name: Parse installed Java version
    set_fact:
      installed_java_version: "{{ java_version_output.stderr | regex_search('openjdk version \"([0-9.]+)\"', '\\1') | first | default('unknown') }}"
    when: java_version_output.rc == 0

  - name: Display Java version information
    debug:
      msg: "installed java verson: {{ java_version_output.stderr }}"

  - name: Assert Java is installed correctly
    assert:
      that:
        - java_version_output.rc == 0
        - (jdk_version | string) in java_version_output.stderr
        # - java_package_name in choco_final_packages.stdout
      fail_msg: "Java installation verification failed - expected {{ java_package_name }}"
      success_msg: "Java {{ java_version | default('21') }} installed successfully at {{ java_home }}"
  become: no
