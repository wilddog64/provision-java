---
- block:
  - name: Set Java paths and download URL
    set_fact:
      java_home: "{{ java_install_base_dir }}/{{ java_symlink_name }}"
      java_versioned_dir: "{{ java_install_base_dir }}/jdk-{{ jdk_version }}"
      java_download_url: "https://aka.ms/download-jdk/microsoft-jdk-{{ jdk_version }}-windows-x64.zip"

  - name: Check if target version is already installed
    ansible.windows.win_stat:
      path: "{{ java_versioned_dir }}/bin/java.exe"
    register: java_target_installed

  - name: Check if symlink exists
    ansible.windows.win_stat:
      path: "{{ java_home }}"
    register: java_symlink_stat

  - name: Find any existing Java installations
    ansible.windows.win_find:
      paths: "{{ java_install_base_dir }}"
      patterns: "jdk-*"
      file_type: directory
    register: existing_java_dirs

  - name: Set facts about existing installations
    set_fact:
      java_already_installed: "{{ (existing_java_dirs.files | length) > 0 }}"
      java_needs_upgrade: "{{ (existing_java_dirs.files | length) > 0 and not java_target_installed.stat.exists }}"
      existing_java_path: "{{ existing_java_dirs.files[0].path if (existing_java_dirs.files | length) > 0 else '' }}"

  - name: Display Java installation status
    debug:
      msg: >-
        {% if java_target_installed.stat.exists %}
        Java {{ jdk_version }} already installed at {{ java_home }}
        {% elif java_needs_upgrade %}
        Java upgrade needed - existing installation found at {{ existing_java_path }}
        {% else %}
        Java not found - will install
        {% endif %}

  - name: Remove old symlink for upgrade
    ansible.windows.win_file:
      path: "{{ java_home }}"
      state: absent
    when: java_symlink_stat.stat.exists and (java_needs_upgrade or not java_target_installed.stat.exists)

  - name: Ensure temp directory exists
    ansible.windows.win_file:
      path: "{{ java_temp_dir }}"
      state: directory
    when: not java_target_installed.stat.exists

  - name: Download Java ZIP
    ansible.windows.win_get_url:
      url: "{{ java_download_url }}"
      dest: "{{ java_temp_dir }}/microsoft-jdk-{{ jdk_version }}.zip"
    register: java_download
    when: not java_target_installed.stat.exists

  - name: Ensure Java install directory exists
    ansible.windows.win_file:
      path: "{{ java_install_base_dir }}"
      state: directory
    when: not java_target_installed.stat.exists

  - name: Extract Java archive
    community.windows.win_unzip:
      src: "{{ java_temp_dir }}/microsoft-jdk-{{ jdk_version }}.zip"
      dest: "{{ java_install_base_dir }}"
    when: not java_target_installed.stat.exists
    register: java_extract

  - name: Find extracted Java directories
    ansible.windows.win_find:
      paths: "{{ java_install_base_dir }}"
      patterns: "jdk-{{ jdk_version | string }}*"
      file_type: directory
    register: extracted_java_dirs
    when: not java_target_installed.stat.exists

  - name: Determine extracted directory path
    set_fact:
      extracted_java_dir_path: >-
        {{ (extracted_java_dirs.files
            | rejectattr('path', 'equalto', java_versioned_dir)
            | sort(attribute='lastwritetime')
            | last).path | default('') }}
    when:
      - not java_target_installed.stat.exists
      - extracted_java_dirs.files is defined
      - extracted_java_dirs.files | length > 0

  - name: Display extracted directory
    debug:
      msg: "Found extracted directory: {{ extracted_java_dir_path | default('none') }}"
    when: not java_target_installed.stat.exists

  - name: Rename extracted directory to target name
    ansible.windows.win_command: 'cmd /c move "{{ extracted_java_dir_path }}" "{{ java_versioned_dir }}"'
    when:
      - not java_target_installed.stat.exists
      - extracted_java_dir_path | default('') | length > 0
      - extracted_java_dir_path != java_versioned_dir
    register: java_rename_result
    failed_when: java_rename_result.rc != 0 and 'already exists' not in java_rename_result.stderr

  - name: Verify Java files were extracted
    ansible.windows.win_stat:
      path: "{{ java_versioned_dir }}/bin/java.exe"
    register: java_files_check
    when: not java_target_installed.stat.exists

  - name: Assert Java files exist after extraction
    assert:
      that:
        - java_files_check.stat.exists
      fail_msg: "Java files not found after extraction at {{ java_versioned_dir }}"
      success_msg: "Java files verified at {{ java_versioned_dir }}"
    when: not java_target_installed.stat.exists

  - name: Create symlink to current Java version
    ansible.windows.win_command: 'cmd /c mklink /D "{{ java_home }}" "{{ java_versioned_dir }}"'
    when: not java_target_installed.stat.exists or java_needs_upgrade
    register: java_symlink_result
    failed_when: java_symlink_result.rc != 0 and 'already exists' not in java_symlink_result.stderr

  - name: Display symlink creation result
    debug:
      msg: "Java symlink created: {{ java_home }} -> {{ java_versioned_dir }}"
    when: java_symlink_result is changed

  - name: Find all Java version directories for cleanup
    ansible.windows.win_find:
      paths: "{{ java_install_base_dir }}"
      patterns: "jdk-*"
      file_type: directory
    register: all_java_dirs
    when: java_keep_versions | int > 0

  - name: Sort Java directories by modification time (newest first)
    set_fact:
      sorted_java_dirs: "{{ all_java_dirs.files | sort(attribute='lastwritetime') | reverse | list }}"
    when:
      - java_keep_versions | int > 0
      - all_java_dirs.files is defined
      - all_java_dirs.files | length > 0

  - name: Identify old Java versions to remove
    set_fact:
      java_dirs_to_remove: "{{ sorted_java_dirs[java_keep_versions | int:] }}"
    when:
      - java_keep_versions | int > 0
      - sorted_java_dirs is defined
      - sorted_java_dirs | length > (java_keep_versions | int)

  - name: Display Java versions to be removed
    debug:
      msg: "Removing old Java version: {{ item.path }}"
    loop: "{{ java_dirs_to_remove | default([]) }}"
    when: java_dirs_to_remove is defined

  - name: Remove old Java versions beyond retention policy
    ansible.windows.win_file:
      path: "{{ item.path }}"
      state: absent
    loop: "{{ java_dirs_to_remove | default([]) }}"
    when:
      - java_keep_versions | int > 0
      - java_dirs_to_remove is defined
      - java_dirs_to_remove | length > 0

  - name: Set JAVA_HOME environment variable
    win_environment:
      name: JAVA_HOME
      value: "{{ java_home }}"
      level: machine

  - name: Set java_home fact
    set_fact:
      java_home: "{{ java_home }}"

  - name: Add Java to PATH
    win_path:
      elements:
        - "{{ java_home }}/bin"

  - name: Verify Java installation
    win_command: "{{ java_home }}/bin/java.exe -version"
    register: java_version_output
    changed_when: false

  - name: Parse installed Java version
    set_fact:
      installed_java_version: "{{ java_version_output.stderr | regex_search('openjdk version \"([0-9.]+)\"', '\\1') | first | default('unknown') }}"
    when: java_version_output.rc == 0

  - name: Display Java version information
    debug:
      msg: "Installed Java version: {{ java_version_output.stderr }}"

  - name: Assert Java is installed correctly
    assert:
      that:
        - java_version_output.rc == 0
        - (jdk_version | string) in java_version_output.stderr
      fail_msg: "Java installation verification failed - expected version {{ jdk_version }}"
      success_msg: "Java {{ jdk_version }} installed successfully at {{ java_home }}"

  - name: Clean up downloaded zip
    ansible.windows.win_file:
      path: "{{ java_temp_dir }}/microsoft-jdk-{{ jdk_version }}.zip"
      state: absent
    when: java_download.changed | default(false)

  become: no
